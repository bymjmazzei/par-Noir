# DDoS Protection Configuration
# Identity Protocol - Production Security

# Rate Limiting Configuration
rate_limiting {
    # General rate limiting
    general {
        requests_per_second 100
        burst_size 200
        window_size 60
    }
    
    # API rate limiting
    api {
        requests_per_second 50
        burst_size 100
        window_size 60
    }
    
    # Authentication rate limiting
    auth {
        requests_per_second 10
        burst_size 20
        window_size 300
    }
    
    # DID operations rate limiting
    did_operations {
        requests_per_second 20
        burst_size 40
        window_size 60
    }
}

# Connection Limiting
connection_limiting {
    # Maximum connections per IP
    max_connections_per_ip 50
    
    # Maximum connections per subnet
    max_connections_per_subnet 200
    
    # Connection timeout
    connection_timeout 30
    
    # Keep-alive timeout
    keepalive_timeout 65
}

# Traffic Analysis
traffic_analysis {
    # Anomaly detection
    anomaly_detection {
        enabled true
        threshold 3.0
        window_size 300
    }
    
    # Protocol analysis
    protocol_analysis {
        # HTTP flood detection
        http_flood {
            enabled true
            threshold 100
            window_size 60
        }
        
        # SYN flood detection
        syn_flood {
            enabled true
            threshold 50
            window_size 30
        }
        
        # UDP flood detection
        udp_flood {
            enabled true
            threshold 200
            window_size 60
        }
    }
    
    # Geographic analysis
    geographic_analysis {
        enabled true
        suspicious_regions ["XX", "YY"]  # Example regions
        max_connections_per_country 1000
    }
}

# Mitigation Actions
mitigation {
    # Automatic mitigation
    automatic {
        enabled true
        action "rate_limit"
        duration 300
    }
    
    # Manual mitigation
    manual {
        action "block"
        duration 3600
    }
    
    # Progressive mitigation
    progressive {
        level1 {
            action "rate_limit"
            threshold 50
            duration 60
        }
        level2 {
            action "challenge"
            threshold 100
            duration 300
        }
        level3 {
            action "block"
            threshold 200
            duration 1800
        }
    }
}

# Cloudflare Integration (if using Cloudflare)
cloudflare {
    # API configuration
    api_token "${CLOUDFLARE_API_TOKEN}"
    zone_id "${CLOUDFLARE_ZONE_ID}"
    
    # Security level
    security_level "high"
    
    # Challenge passage time
    challenge_passage_time 30
    
    # Browser integrity check
    browser_integrity_check true
    
    # Always online
    always_online true
}

# Monitoring and Alerting
monitoring {
    # Metrics collection
    metrics {
        enabled true
        interval 60
        retention_days 30
    }
    
    # Alerting
    alerts {
        # High traffic alert
        high_traffic {
            threshold 1000
            window_size 60
            action "email"
            recipients ["security@your-domain.com"]
        }
        
        # DDoS attack alert
        ddos_attack {
            threshold 500
            window_size 30
            action "email,slack"
            recipients ["security@your-domain.com", "ops@your-domain.com"]
        }
        
        # Geographic anomaly alert
        geo_anomaly {
            threshold 100
            window_size 300
            action "email"
            recipients ["security@your-domain.com"]
        }
    }
    
    # Integration with SIEM
    siem {
        enabled true
        endpoint "https://siem.your-domain.com/api/events"
        api_key "${SIEM_API_KEY}"
        event_types ["ddos_attack", "rate_limit_exceeded", "geo_anomaly"]
    }
}

# Whitelist Configuration
whitelist {
    # Trusted IPs
    trusted_ips [
        "10.0.0.0/8",
        "172.16.0.0/12",
        "192.168.0.0/16"
    ]
    
    # Trusted ASNs
    trusted_asns [12345, 67890]  # Example ASNs
    
    # Trusted countries
    trusted_countries ["US", "CA", "GB", "DE", "FR", "AU", "JP"]
    
    # Trusted user agents
    trusted_user_agents [
        "IdentityProtocol/1.0",
        "Mozilla/5.0 (compatible; IdentityBot/1.0)"
    ]
}

# Blacklist Configuration
blacklist {
    # Known malicious IPs
    malicious_ips [
        "192.168.1.100",
        "10.0.0.100"
    ]
    
    # Known malicious ASNs
    malicious_asns [99999]  # Example ASN
    
    # Known malicious countries
    malicious_countries ["XX", "YY"]  # Example countries
    
    # Known malicious user agents
    malicious_user_agents [
        "bot",
        "crawler",
        "scanner"
    ]
}

# Performance Settings
performance {
    # Memory limits
    max_memory "2GB"
    
    # CPU limits
    max_cpu_percent 80
    
    # Cache settings
    cache_size "500MB"
    cache_ttl 3600
    
    # Worker processes
    worker_processes 8
    
    # Queue size
    max_queue_size 10000
}

# Logging Configuration
logging {
    # Log file
    log_file "/var/log/ddos/events.log"
    
    # Log level
    log_level "info"
    
    # Log rotation
    rotation {
        size "100MB"
        keep 30
        compress true
    }
    
    # Log format
    format "json"
    
    # Fields to log
    fields [
        "timestamp",
        "ip_address",
        "user_agent",
        "request_method",
        "request_uri",
        "response_code",
        "response_time",
        "bytes_sent",
        "referer",
        "country",
        "asn",
        "mitigation_action"
    ]
}
