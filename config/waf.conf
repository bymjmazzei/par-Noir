# Web Application Firewall (WAF) Configuration
# Identity Protocol - Production Security

# WAF Rules Engine Configuration
waf_rules {
    # SQL Injection Prevention
    rule "sql_injection" {
        pattern ".*(union|select|insert|update|delete|drop|create|alter|exec|execute|script).*"
        action "block"
        severity "high"
        rate_limit 10
        rate_window 60
    }

    # XSS Prevention
    rule "xss_attack" {
        pattern ".*(<script|javascript:|vbscript:|onload=|onerror=|onclick=).*"
        action "block"
        severity "high"
        rate_limit 15
        rate_window 60
    }

    # Path Traversal Prevention
    rule "path_traversal" {
        pattern ".*(\\.\\./|\\.\\.\\\\)"
        action "block"
        severity "medium"
        rate_limit 20
        rate_window 60
    }

    # Command Injection Prevention
    rule "command_injection" {
        pattern ".*(;|\\||&|`|\\$\\()"
        action "block"
        severity "high"
        rate_limit 5
        rate_window 60
    }

    # File Upload Restrictions
    rule "malicious_upload" {
        pattern ".*\\.(php|asp|aspx|jsp|exe|bat|cmd|sh)$"
        action "block"
        severity "critical"
        rate_limit 3
        rate_window 300
    }

    # Authentication Bypass
    rule "auth_bypass" {
        pattern ".*(admin|root|test|guest|anonymous).*"
        action "challenge"
        severity "medium"
        rate_limit 10
        rate_window 120
    }

    # Rate Limiting
    rule "rate_limit" {
        pattern ".*"
        action "rate_limit"
        severity "low"
        rate_limit 100
        rate_window 60
    }
}

# IP Reputation and Blacklisting
ip_reputation {
    # Known malicious IPs
    blacklist_file "/etc/waf/blacklist.txt"
    
    # Geolocation restrictions
    allowed_countries ["US", "CA", "GB", "DE", "FR", "AU", "JP"]
    
    # ASN restrictions
    blocked_asns [12345, 67890]  # Example ASNs
    
    # Dynamic IP reputation
    reputation_threshold 50
    reputation_window 3600
}

# Request Validation
request_validation {
    # Maximum request size
    max_request_size "10MB"
    
    # Allowed HTTP methods
    allowed_methods ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    
    # Required headers
    required_headers ["User-Agent", "Accept"]
    
    # Content-Type validation
    allowed_content_types [
        "application/json",
        "application/x-www-form-urlencoded",
        "multipart/form-data",
        "text/plain"
    ]
}

# Response Security Headers
security_headers {
    # Content Security Policy
    csp "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
    
    # X-Frame-Options
    x_frame_options "DENY"
    
    # X-Content-Type-Options
    x_content_type_options "nosniff"
    
    # X-XSS-Protection
    x_xss_protection "1; mode=block"
    
    # Referrer Policy
    referrer_policy "strict-origin-when-cross-origin"
    
    # Permissions Policy
    permissions_policy "geolocation=(), microphone=(), camera=()"
}

# Logging and Monitoring
logging {
    # WAF event logging
    log_file "/var/log/waf/events.log"
    log_level "info"
    
    # Alert configuration
    alert_email "security@your-domain.com"
    alert_threshold 10
    
    # Integration with SIEM
    siem_endpoint "https://siem.your-domain.com/api/events"
    siem_api_key "${SIEM_API_KEY}"
}

# Performance Settings
performance {
    # Cache size
    cache_size "100MB"
    
    # Worker processes
    worker_processes 4
    
    # Connection limits
    max_connections 10000
    
    # Timeout settings
    request_timeout 30
    keepalive_timeout 65
}

# Custom Rules for Identity Protocol
custom_rules {
    # DID validation
    rule "did_validation" {
        pattern "^did:[a-z0-9]+:[a-zA-Z0-9._-]+$"
        action "validate"
        severity "medium"
    }
    
    # JWT token validation
    rule "jwt_validation" {
        pattern "^[A-Za-z0-9-_=]+\\.[A-Za-z0-9-_=]+\\.?[A-Za-z0-9-_.+/=]*$"
        action "validate"
        severity "medium"
    }
    
    # API endpoint protection
    rule "api_protection" {
        pattern "^/api/v1/.*"
        action "rate_limit"
        severity "medium"
        rate_limit 50
        rate_window 60
    }
}
