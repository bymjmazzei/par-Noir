var t=Object.defineProperty,i=Object.getOwnPropertySymbols,e=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,s=(i,e,n)=>e in i?t(i,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[e]=n,a=(t,a)=>{for(var o in a||(a={}))e.call(a,o)&&s(t,o,a[o]);if(i)for(var o of i(a))n.call(a,o)&&s(t,o,a[o]);return t},o=(t,i,e)=>s(t,"symbol"!=typeof i?i+"":i,e),r=(t,i,e)=>new Promise((n,s)=>{var a=t=>{try{r(e.next(t))}catch(i){s(i)}},o=t=>{try{r(e.throw(t))}catch(i){s(i)}},r=t=>t.done?n(t.value):Promise.resolve(t.value).then(a,o);r((e=e.apply(t,i)).next())}),c={};const d=class t{constructor(){o(this,"notifications",[]),o(this,"settings"),o(this,"isInitialized",!1),o(this,"pushSubscription",null),o(this,"currentUnlockedIdentity",null),this.settings=this.loadSettings(),this.notifications=this.loadNotifications()}static getInstance(){return t.instance||(t.instance=new t),t.instance}initialize(){return r(this,null,function*(){if(!this.isInitialized)try{"serviceWorker"in navigator&&"PushManager"in window&&(yield this.registerServiceWorker(),yield this.requestNotificationPermission(),yield this.subscribeToPushNotifications()),this.isInitialized=!0}catch(t){}})}registerServiceWorker(){return r(this,null,function*(){})}requestNotificationPermission(){return r(this,null,function*(){})}subscribeToPushNotifications(){return r(this,null,function*(){try{const t=yield navigator.serviceWorker.ready,i=yield t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(c.REACT_APP_VAPID_PUBLIC_KEY||"")});this.pushSubscription=i}catch(t){}})}setUnlockedIdentity(t,i){this.currentUnlockedIdentity={id:t,nickname:i}}clearUnlockedIdentity(){this.currentUnlockedIdentity=null}getNotificationsForCurrentIdentity(){return this.currentUnlockedIdentity?this.notifications.filter(t=>t.identityId===this.currentUnlockedIdentity.id):[]}getUnreadCountForCurrentIdentity(){return this.currentUnlockedIdentity?this.notifications.filter(t=>t.identityId===this.currentUnlockedIdentity.id&&!t.read).length:0}createRecoveryRequestNotification(t){return r(this,null,function*(){const i={id:`recovery-${Date.now()}`,type:"recovery-request",title:"Recovery Request",message:`${t.requestingUser} is requesting access to your identity. Recovery code: ${t.recoveryCode||"N/A"}`,timestamp:(new Date).toISOString(),read:!1,identityId:t.identityId,identityNickname:t.identityNickname,priority:"high",actionUrl:`/recovery/${t.identityId}`,metadata:t};yield this.addNotification(i),yield this.sendPushNotification({title:"New Notification",body:`You have a new notification in ${t.identityNickname}`,tag:"recovery-request",data:{type:"recovery-request",identityId:t.identityId},identityId:t.identityId,identityNickname:t.identityNickname})})}createCustodianApprovalNotification(t){return r(this,null,function*(){const i={id:`custodian-${Date.now()}`,type:"custodian-approval",title:"Custodian Action",message:`${t.custodianName} has ${t.action} access to your identity "${t.identityNickname}"`,timestamp:(new Date).toISOString(),read:!1,identityId:t.identityId,identityNickname:t.identityNickname,priority:"medium",actionUrl:"/custodians",metadata:t};yield this.addNotification(i),yield this.sendPushNotification({title:"New Notification",body:`You have a new notification in ${t.identityNickname}`,tag:"custodian-approval",data:{type:"custodian-approval",action:t.action},identityId:t.identityId,identityNickname:t.identityNickname})})}createIntegrationUpdateNotification(t){return r(this,null,function*(){const i={id:`integration-${Date.now()}`,type:"integration-update",title:"Integration Update",message:`${t.integrationName} has been ${t.updateType}${t.details?`: ${t.details}`:""}`,timestamp:(new Date).toISOString(),read:!1,identityId:t.identityId,identityNickname:t.identityNickname,priority:"medium",actionUrl:"/integrations",metadata:t};yield this.addNotification(i),yield this.sendPushNotification({title:"New Notification",body:`You have a new notification in ${t.identityNickname}`,tag:"integration-update",data:{type:"integration-update",integrationName:t.integrationName},identityId:t.identityId,identityNickname:t.identityNickname})})}createSecurityAlertNotification(t){return r(this,null,function*(){const i={id:`security-${Date.now()}`,type:"security-alert",title:"Security Alert",message:t.details,timestamp:(new Date).toISOString(),read:!1,identityId:t.identityId,identityNickname:t.identityNickname,priority:t.severity,actionUrl:"/security",metadata:t};yield this.addNotification(i),yield this.sendPushNotification({title:"New Notification",body:`You have a new notification in ${t.identityNickname}`,tag:"security-alert",data:{type:"security-alert",alertType:t.alertType},identityId:t.identityId,identityNickname:t.identityNickname})})}createSyncCompleteNotification(t){return r(this,null,function*(){const i={id:`sync-${Date.now()}`,type:"sync-complete",title:"Sync Complete",message:`Successfully synced ${t.syncedItems} items${t.failedItems>0?`, ${t.failedItems} failed`:""}`,timestamp:(new Date).toISOString(),read:!1,identityId:t.identityId,identityNickname:t.identityNickname,priority:"low",metadata:t};yield this.addNotification(i),yield this.sendPushNotification({title:"New Notification",body:`You have a new notification in ${t.identityNickname}`,tag:"sync-complete",data:{type:"sync-complete",syncedItems:t.syncedItems},identityId:t.identityId,identityNickname:t.identityNickname})})}createDevicePairingNotification(t){return r(this,null,function*(){const i={id:`device-${Date.now()}`,type:"device-pairing",title:"Device Pairing",message:`${t.deviceName} (${t.deviceType}) has been ${t.action}`,timestamp:(new Date).toISOString(),read:!1,identityId:t.identityId,identityNickname:t.identityNickname,priority:"medium",actionUrl:"/devices",metadata:t};yield this.addNotification(i),yield this.sendPushNotification({title:"New Notification",body:`You have a new notification in ${t.identityNickname}`,tag:"device-pairing",data:{type:"device-pairing",deviceName:t.deviceName},identityId:t.identityId,identityNickname:t.identityNickname})})}addNotification(t){return r(this,null,function*(){this.notifications.unshift(t),this.saveNotifications(),this.settings.showInApp&&this.showInAppNotification(t),this.settings.showSystem&&"granted"===Notification.permission&&this.showSystemNotification(t)})}markAsRead(t){return r(this,null,function*(){const i=this.notifications.find(i=>i.id===t);i&&(i.read=!0,this.saveNotifications())})}markAllAsRead(){return r(this,null,function*(){this.notifications.forEach(t=>t.read=!0),this.saveNotifications()})}deleteNotification(t){return r(this,null,function*(){this.notifications=this.notifications.filter(i=>i.id!==t),this.saveNotifications()})}clearAllNotifications(){return r(this,null,function*(){this.notifications=[],this.saveNotifications()})}getNotifications(){return this.notifications}getNotificationCount(t){return r(this,null,function*(){return this.notifications.filter(i=>i.identityId===t).length})}getUnreadNotificationCount(t){return r(this,null,function*(){return this.notifications.filter(i=>i.identityId===t&&!i.read).length})}getUnreadCount(){return this.notifications.filter(t=>!t.read).length}getCurrentUnlockedIdentity(){return this.currentUnlockedIdentity}getNotificationCountForIdentity(t){return this.notifications.filter(i=>i.identityId===t).length}getUnreadNotificationCountForIdentity(t){return this.notifications.filter(i=>i.identityId===t&&!i.read).length}getNotificationsByType(t){return this.notifications.filter(i=>i.type===t)}updateSettings(t){this.settings=a(a({},this.settings),t),this.saveSettings()}getSettings(){return this.settings}sendPushNotification(t){return r(this,null,function*(){this.pushSubscription&&this.settings.enabled})}showInAppNotification(t){}showSystemNotification(t){"granted"===Notification.permission&&(new Notification(t.title,{body:t.message,icon:"/icons/icon-192x192.png",badge:"/icons/icon-192x192.png",tag:t.id,data:t.metadata}).onclick=()=>{window.focus(),t.actionUrl&&(window.location.href=t.actionUrl)})}loadNotifications(){try{const t=localStorage.getItem("notifications");return t?JSON.parse(t):[]}catch(t){return[]}}saveNotifications(){try{localStorage.setItem("notifications",JSON.stringify(this.notifications))}catch(t){}}loadSettings(){try{const t=localStorage.getItem("notification-settings");return t?JSON.parse(t):{enabled:!0,recoveryRequests:!0,custodianApprovals:!0,integrationUpdates:!0,securityAlerts:!0,syncNotifications:!1,devicePairing:!0,sound:!0,vibration:!0,showInApp:!0,showSystem:!0}}catch(t){return{enabled:!0,recoveryRequests:!0,custodianApprovals:!0,integrationUpdates:!0,securityAlerts:!0,syncNotifications:!1,devicePairing:!0,sound:!0,vibration:!0,showInApp:!0,showSystem:!0}}}saveSettings(){try{localStorage.setItem("notification-settings",JSON.stringify(this.settings))}catch(t){}}urlBase64ToUint8Array(t){const i=(t+"=".repeat((4-t.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),e=window.atob(i),n=new Uint8Array(e.length);for(let s=0;s<e.length;++s)n[s]=e.charCodeAt(s);return n}};o(d,"instance");const l=d.getInstance(),h=class t{constructor(){o(this,"events",[]),o(this,"errors",[]),o(this,"performance",[]),o(this,"sessionId"),o(this,"isEnabled",!1),o(this,"maxStorageSize",1e3),this.sessionId=this.generateSessionId(),this.loadSettings(),this.startPerformanceMonitoring()}static getInstance(){return t.instance||(t.instance=new t),t.instance}initialize(){return r(this,null,function*(){try{this.startSession()}catch(t){}})}enable(){this.isEnabled=!0,localStorage.setItem("analytics_consent","true"),this.startSession()}disable(){this.isEnabled=!1,localStorage.setItem("analytics_consent","false"),this.clearData()}trackEvent(t,i,e,n){if(!this.isEnabled)return;const s={event:"user_action",category:t,action:i,label:e,value:n,timestamp:Date.now(),sessionId:this.sessionId,userId:this.getUserId()};this.events.push(s),this.saveEvents(),this.checkStorageLimit()}trackPageView(t){this.trackEvent("navigation","page_view",t)}trackFeatureUsage(t,i){this.trackEvent("feature",i,t)}trackError(t,i,e="medium"){const n={error:t.name,message:t.message,stack:t.stack,component:i,userId:this.getUserId(),timestamp:Date.now(),sessionId:this.sessionId,severity:e};this.errors.push(n),this.saveErrors()}trackPerformance(t,i,e="ms"){const n={metric:t,value:i,unit:e,timestamp:Date.now(),sessionId:this.sessionId};this.performance.push(n),this.savePerformance()}getAnalyticsData(){return{events:this.events,errors:this.errors,performance:this.performance,sessionId:this.sessionId,isEnabled:this.isEnabled}}exportData(){const t={version:"1.0",timestamp:(new Date).toISOString(),sessionId:this.sessionId,events:this.events,errors:this.errors,performance:this.performance};return JSON.stringify(t,null,2)}clearData(){this.events=[],this.errors=[],this.performance=[],this.saveEvents(),this.saveErrors(),this.savePerformance()}getSummary(){const t=Date.now()-this.getSessionStart();return{totalEvents:this.events.length,totalErrors:this.errors.length,totalPerformanceMetrics:this.performance.length,sessionDuration:t,isEnabled:this.isEnabled}}startPerformanceMonitoring(){"undefined"!=typeof window&&(window.addEventListener("load",()=>{const t=performance.getEntriesByType("navigation")[0];t&&(this.trackPerformance("page_load_time",t.loadEventEnd-t.loadEventStart),this.trackPerformance("dom_content_loaded",t.domContentLoadedEventEnd-t.domContentLoadedEventStart))}),"memory"in performance&&setInterval(()=>{const t=performance.memory;this.trackPerformance("memory_usage",t.usedJSHeapSize,"bytes")},3e4))}startSession(){this.sessionId=this.generateSessionId(),localStorage.setItem("analytics_session_start",Date.now().toString()),this.trackEvent("session","start")}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,15)}`}getUserId(){return localStorage.getItem("user_id")||void 0}getSessionStart(){const t=localStorage.getItem("analytics_session_start");return t?parseInt(t):Date.now()}loadSettings(){try{const t=localStorage.getItem("analytics_events"),i=localStorage.getItem("analytics_errors"),e=localStorage.getItem("analytics_performance");t&&(this.events=JSON.parse(t)),i&&(this.errors=JSON.parse(i)),e&&(this.performance=JSON.parse(e))}catch(t){}}saveEvents(){try{localStorage.setItem("analytics_events",JSON.stringify(this.events))}catch(t){}}saveErrors(){try{localStorage.setItem("analytics_errors",JSON.stringify(this.errors))}catch(t){}}savePerformance(){try{localStorage.setItem("analytics_performance",JSON.stringify(this.performance))}catch(t){}}checkStorageLimit(){this.events.length>this.maxStorageSize&&(this.events=this.events.slice(-this.maxStorageSize/2),this.saveEvents())}};o(h,"instance");const y=h.getInstance();export{y as a,l as n};
