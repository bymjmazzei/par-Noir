var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,o=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,a=(e,t,n)=>o(e,"symbol"!=typeof t?t+"":t,n),c=(e,t,n)=>new Promise((r,i)=>{var s=e=>{try{a(n.next(e))}catch(t){i(t)}},o=e=>{try{a(n.throw(e))}catch(t){i(t)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(s,o);a((n=n.apply(e,t)).next())});const d=class e{constructor(){a(this,"db",null)}init(){return c(this,null,function*(){return new Promise((t,n)=>{const r=indexedDB.open(e.DB_NAME,e.DB_VERSION);r.onerror=()=>n(new Error("Failed to open database")),r.onsuccess=()=>{this.db=r.result,t()},r.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("identities")||t.createObjectStore("identities",{keyPath:"publicKey"}).createIndex("lastAccessed","lastAccessed",{unique:!1}),t.objectStoreNames.contains("sessions")||t.createObjectStore("sessions",{keyPath:"id"}).createIndex("expiresAt","expiresAt",{unique:!1}),t.objectStoreNames.contains("custodians")||t.createObjectStore("custodians",{keyPath:"id"}).createIndex("identityId","identityId",{unique:!1}),t.objectStoreNames.contains("devices")||t.createObjectStore("devices",{keyPath:"id"}).createIndex("identityId","identityId",{unique:!1}),t.objectStoreNames.contains("settings")||t.createObjectStore("settings",{keyPath:"key"})}})})}storeIdentity(e){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");const t={publicKey:e.publicKey,encryptedData:e.encryptedData,iv:e.iv,salt:e.salt,lastAccessed:(new Date).toISOString()};return this.performTransaction("identities","readwrite",e=>{e.put(t)})})}getIdentities(){return c(this,null,function*(){return this.performTransaction("identities","readonly",e=>new Promise((t,n)=>{const r=e.getAll();r.onsuccess=()=>t(r.result),r.onerror=()=>n(r.error)}))})}getIdentity(e){return c(this,null,function*(){return this.performTransaction("identities","readonly",t=>new Promise((n,r)=>{const i=t.get(e);i.onsuccess=()=>n(i.result),i.onerror=()=>r(i.error)}))})}createIdentity(e){return c(this,null,function*(){const t={publicKey:`mock-${Date.now()}`,encryptedData:"mock-encrypted-data",iv:"mock-iv",salt:"mock-salt",lastAccessed:(new Date).toISOString(),id:`mock-${Date.now()}`,username:e,nickname:e,createdAt:(new Date).toISOString()};return yield this.storeIdentity(t),t})}updateIdentity(e,a){return c(this,null,function*(){const c=yield this.getIdentity(e);if(!c)throw new Error("Identity not found");const d=(l=((e,t)=>{for(var n in t||(t={}))i.call(t,n)&&o(e,n,t[n]);if(r)for(var n of r(t))s.call(t,n)&&o(e,n,t[n]);return e})({},c),u={nickname:a,lastAccessed:(new Date).toISOString()},t(l,n(u)));var l,u;return yield this.storeIdentity(d),d})}deleteIdentity(e){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");return this.performTransaction("identities","readwrite",t=>{t.delete(e)})})}storeSession(e){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");const t={id:e.id,accessToken:e.accessToken,expiresAt:new Date(Date.now()+1e3*e.expiresIn).toISOString(),createdAt:e.authenticatedAt};return this.performTransaction("sessions","readwrite",e=>{e.put(t)})})}getCurrentSession(){return c(this,null,function*(){return this.performTransaction("sessions","readonly",e=>new Promise((t,n)=>{const r=e.getAll();r.onsuccess=()=>{const e=r.result.find(e=>new Date(e.expiresAt)>new Date);t(e||null)},r.onerror=()=>n(r.error)}))})}clearExpiredSessions(){return c(this,null,function*(){return this.performTransaction("sessions","readwrite",e=>new Promise((t,n)=>{const r=e.getAll();r.onsuccess=()=>{r.result.filter(e=>new Date(e.expiresAt)<=new Date).forEach(t=>e.delete(t.id)),t()},r.onerror=()=>n(r.error)}))})}storeCustodian(e){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");return this.performTransaction("custodians","readwrite",t=>{t.put(e)})})}getCustodians(e){return c(this,null,function*(){return this.performTransaction("custodians","readonly",t=>new Promise((n,r)=>{const i=t.index("identityId").getAll(e);i.onsuccess=()=>n(i.result),i.onerror=()=>r(i.error)}))})}storeDevice(e){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");return this.performTransaction("devices","readwrite",t=>{t.put(e)})})}getDevices(e){return c(this,null,function*(){return this.performTransaction("devices","readonly",t=>new Promise((n,r)=>{const i=t.index("identityId").getAll(e);i.onsuccess=()=>n(i.result),i.onerror=()=>r(i.error)}))})}storeSetting(e,t){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");return this.performTransaction("settings","readwrite",n=>{n.put({key:e,value:JSON.stringify(t)})})})}getSetting(e){return c(this,null,function*(){return this.performTransaction("settings","readonly",t=>new Promise((n,r)=>{const i=t.get(e);i.onsuccess=()=>{const e=i.result;n(e?JSON.parse(e.value):null)},i.onerror=()=>r(i.error)}))})}getAllSettings(){return c(this,null,function*(){return this.performTransaction("settings","readonly",e=>new Promise((t,n)=>{const r=e.getAll();r.onsuccess=()=>{const e={},n=r.result;for(const t of n)e[t.key]=JSON.parse(t.value);t(e)},r.onerror=()=>n(r.error)}))})}exportData(){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");const e={version:"1.0",timestamp:(new Date).toISOString(),identities:yield this.getIdentities()};return JSON.stringify(e,null,2)})}importData(e){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");const t=JSON.parse(e);yield this.clearAllData();for(const e of t.identities||[])yield this.storeIdentity(e)})}clearAllData(){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");yield this.performTransaction("identities","readwrite",e=>{e.clear()})})}performTransaction(e,t,n){return c(this,null,function*(){if(!this.db)throw new Error("Database not initialized");return new Promise((r,i)=>{const s=this.db.transaction(e,t),o=s.objectStore(e);s.onerror=()=>i(new Error("Transaction failed"));try{const e=n(o);e instanceof Promise?e.then(r).catch(i):r(e)}catch(a){i(a)}})})}};a(d,"DB_NAME","IdentityProtocolDB"),a(d,"DB_VERSION",1);let l=d;const u=new class{constructor(e={}){a(this,"encryptionKey"),a(this,"maxAge"),a(this,"version"),a(this,"db",null),a(this,"dbName","IdentityDashboardDB"),a(this,"dbVersion",1),this.encryptionKey=e.encryptionKey||this.generateKey(),this.maxAge=e.maxAge||2592e6,this.version=e.version||"1.0.0",this.initIndexedDB()}initIndexedDB(){return c(this,null,function*(){return new Promise((e,t)=>{const n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("identities")||t.createObjectStore("identities",{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),t.objectStoreNames.contains("recovery")||t.createObjectStore("recovery",{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1}),t.objectStoreNames.contains("settings")||t.createObjectStore("settings",{keyPath:"key"}),t.objectStoreNames.contains("sync")||t.createObjectStore("sync",{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1})}})})}generateKey(){const e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}encrypt(e){return c(this,null,function*(){const t=new TextEncoder,n=t.encode(e),r=yield crypto.subtle.importKey("raw",t.encode(this.encryptionKey),{name:"AES-GCM"},!1,["encrypt"]),i=crypto.getRandomValues(new Uint8Array(12)),s=yield crypto.subtle.encrypt({name:"AES-GCM",iv:i},r,n),o=new Uint8Array(s),a=new Uint8Array(i.length+o.length);return a.set(i),a.set(o,i.length),btoa(String.fromCharCode(...a))})}decrypt(e){return c(this,null,function*(){try{const t=new Uint8Array(atob(e).split("").map(e=>e.charCodeAt(0))),n=t.slice(0,12),r=t.slice(12),i=yield crypto.subtle.importKey("raw",(new TextEncoder).encode(this.encryptionKey),{name:"AES-GCM"},!1,["decrypt"]),s=yield crypto.subtle.decrypt({name:"AES-GCM",iv:n},i,r);return(new TextDecoder).decode(s)}catch(t){throw new Error("Failed to decrypt data")}})}generateChecksum(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return t.toString(16)}setItem(e,t,n=!1){return c(this,null,function*(){const r={data:t,timestamp:Date.now(),version:this.version,checksum:this.generateChecksum(JSON.stringify(t))},i=yield this.encrypt(JSON.stringify(r));n&&this.db?yield this.setItemIndexedDB(e,i):localStorage.setItem(e,i)})}getItem(e,t=!1){return c(this,null,function*(){try{let n;if(n=t&&this.db?yield this.getItemIndexedDB(e):localStorage.getItem(e)||"",!n)return null;const r=yield this.decrypt(n),i=JSON.parse(r);i.version,this.version;const s=this.generateChecksum(JSON.stringify(i.data));if(i.checksum!==s)throw new Error("Data integrity check failed");return Date.now()-i.timestamp>this.maxAge?(this.removeItem(e,t),null):i.data}catch(n){return null}})}removeItem(e,t=!1){return c(this,null,function*(){t&&this.db?yield this.removeItemIndexedDB(e):localStorage.removeItem(e)})}clear(e=!1){return c(this,null,function*(){e&&this.db?yield this.clearIndexedDB():localStorage.clear()})}setItemIndexedDB(e,t){return c(this,null,function*(){return new Promise((n,r)=>{if(!this.db)return void r(new Error("IndexedDB not initialized"));const i=this.db.transaction(["identities","recovery","settings","sync"],"readwrite").objectStore("settings").put({key:e,value:t,timestamp:Date.now()});i.onsuccess=()=>n(),i.onerror=()=>r(i.error)})})}getItemIndexedDB(e){return c(this,null,function*(){return new Promise((t,n)=>{if(!this.db)return void n(new Error("IndexedDB not initialized"));const r=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);r.onsuccess=()=>{const e=r.result;t(e?e.value:"")},r.onerror=()=>n(r.error)})})}removeItemIndexedDB(e){return c(this,null,function*(){return new Promise((t,n)=>{if(!this.db)return void n(new Error("IndexedDB not initialized"));const r=this.db.transaction(["settings"],"readwrite").objectStore("settings").delete(e);r.onsuccess=()=>t(),r.onerror=()=>n(r.error)})})}clearIndexedDB(){return c(this,null,function*(){return new Promise((e,t)=>{if(!this.db)return void t(new Error("IndexedDB not initialized"));const n=this.db.transaction(["identities","recovery","settings","sync"],"readwrite");n.oncomplete=()=>e(),n.onerror=()=>t(n.error),["identities","recovery","settings","sync"].forEach(e=>{n.objectStore(e).clear()})})})}saveIdentity(e){return c(this,null,function*(){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((t,n)=>{const r=this.db.transaction(["identities"],"readwrite").objectStore("identities").put({id:e.id,data:e,timestamp:Date.now()});r.onsuccess=()=>t(),r.onerror=()=>n(r.error)})})}getIdentity(e){return c(this,null,function*(){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((t,n)=>{const r=this.db.transaction(["identities"],"readonly").objectStore("identities").get(e);r.onsuccess=()=>{const e=r.result;t(e?e.data:null)},r.onerror=()=>n(r.error)})})}getAllIdentities(){return c(this,null,function*(){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((e,t)=>{const n=this.db.transaction(["identities"],"readonly").objectStore("identities").getAll();n.onsuccess=()=>{const t=n.result;e(t.map(e=>e.data))},n.onerror=()=>t(n.error)})})}deleteIdentity(e){return c(this,null,function*(){if(!this.db)throw new Error("IndexedDB not initialized");return new Promise((t,n)=>{const r=this.db.transaction(["identities"],"readwrite").objectStore("identities").delete(e);r.onsuccess=()=>t(),r.onerror=()=>n(r.error)})})}exportData(){return c(this,null,function*(){const e={identities:yield this.getAllIdentities(),settings:yield this.getItem("settings",!0),timestamp:Date.now(),version:this.version};return btoa(JSON.stringify(e))})}importData(e){return c(this,null,function*(){try{const t=JSON.parse(atob(e));t.version,this.version,yield this.clear(!0);for(const e of t.identities)yield this.saveIdentity(e);t.settings&&(yield this.setItem("settings",t.settings,!0))}catch(t){throw new Error("Invalid import data")}})}getStorageStats(){return c(this,null,function*(){try{const e=yield this.getAllIdentities(),t=yield this.getItem("settings",!0);return{totalSize:JSON.stringify({identities:e,settings:t}).length,itemCount:e.length+(t?1:0),identitiesCount:e.length,lastBackup:yield this.getItem("lastBackup",!0)}}catch(e){return{totalSize:0,itemCount:0,identitiesCount:0,lastBackup:null}}})}},h=Object.freeze(Object.defineProperty({__proto__:null,secureStorage:u},Symbol.toStringTag,{value:"Module"}));export{l as S,h as l,u as s};
