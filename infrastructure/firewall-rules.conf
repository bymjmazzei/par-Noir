# Firewall Rules Configuration for Production Identity Protocol Servers
# This file contains iptables rules for securing production infrastructure

# Flush existing rules
iptables -F
iptables -X

# Set default policies
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Allow localhost traffic
iptables -A INPUT -i lo -j ACCEPT

# Allow established connections
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow SSH from specific IPs only (restrict this to your admin IPs)
iptables -A INPUT -p tcp --dport 22 -s YOUR_ADMIN_IP/32 -j ACCEPT

# Allow HTTP traffic
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# Allow HTTPS traffic
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# Allow API traffic
iptables -A INPUT -p tcp --dport 3001 -j ACCEPT

# Allow monitoring/metrics port (restrict to internal network)
iptables -A INPUT -p tcp --dport 9090 -s 10.0.0.0/8 -j ACCEPT

# Allow health check endpoints
iptables -A INPUT -p tcp --dport 8080 -j ACCEPT

# Block common attack ports
iptables -A INPUT -p tcp --dport 22 -j DROP  # Block SSH from non-admin IPs
iptables -A INPUT -p tcp --dport 21 -j DROP  # Block FTP
iptables -A INPUT -p tcp --dport 23 -j DROP  # Block Telnet
iptables -A INPUT -p tcp --dport 25 -j DROP  # Block SMTP
iptables -A INPUT -p tcp --dport 3306 -j DROP  # Block MySQL
iptables -A INPUT -p tcp --dport 5432 -j DROP  # Block PostgreSQL
iptables -A INPUT -p tcp --dport 27017 -j DROP  # Block MongoDB
iptables -A INPUT -p tcp --dport 6379 -j DROP  # Block Redis

# Block ICMP (ping) except from admin IPs
iptables -A INPUT -p icmp -s YOUR_ADMIN_IP/32 -j ACCEPT
iptables -A INPUT -p icmp -j DROP

# Rate limiting for brute force protection
iptables -A INPUT -p tcp --dport 22 -m recent --name SSH --set
iptables -A INPUT -p tcp --dport 22 -m recent --name SSH --update --seconds 60 --hitcount 3 -j DROP

# Rate limiting for API endpoints
iptables -A INPUT -p tcp --dport 3001 -m recent --name API --set
iptables -A INPUT -p tcp --dport 3001 -m recent --name API --update --seconds 60 --hitcount 100 -j DROP

# Block suspicious IP ranges
iptables -A INPUT -s 0.0.0.0/8 -j DROP
iptables -A INPUT -s 127.0.0.0/8 -j DROP
iptables -A INPUT -s 169.254.0.0/16 -j DROP
iptables -A INPUT -s 172.16.0.0/12 -j DROP
iptables -A INPUT -s 192.168.0.0/16 -j DROP
iptables -A INPUT -s 224.0.0.0/4 -j DROP
iptables -A INPUT -s 240.0.0.0/5 -j DROP

# Log dropped packets for monitoring
iptables -A INPUT -j LOG --log-prefix "IPTABLES-DROPPED: "

# Save rules
iptables-save > /etc/iptables/rules.v4

echo "Firewall rules configured successfully"
echo "Remember to:"
echo "1. Replace YOUR_ADMIN_IP with your actual admin IP address"
echo "2. Test connectivity before applying to production"
echo "3. Monitor logs for blocked traffic"
echo "4. Adjust rules based on your specific network requirements"
